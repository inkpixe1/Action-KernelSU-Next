name: ğŸ”„ æ£€æŸ¥ KSU ç‰ˆæœ¬æ›´æ–°å¹¶æ„å»º

on:
  schedule:
    - cron: '0 */2 * * *'  # ğŸ•°ï¸ æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:  # ğŸ¯ ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘

jobs:
  check-ksu-version:
    name: "ğŸ” æ£€æŸ¥ KSU ç‰ˆæœ¬"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¦ æ£€å‡ºä»£ç "
        uses: actions/checkout@v3

      - name: "ğŸŒ ä» GitHub è·å–æœ€æ–° KSU ç‰ˆæœ¬"
        id: fetch-latest-ksu-version
        run: |
          # ğŸŒŸ å…‹éš† KernelSU-Next ä»“åº“
          git clone https://github.com/rifsxd/KernelSU-Next.git
          cd KernelSU-Next
          # ğŸ“ˆ è·å–æœ€æ–°çš„ KSU_VERSION
          LATEST_KSU_VERSION=$(expr $(/usr/bin/git rev-list --count HEAD) "+" 10200)
          echo "æœ€æ–° KSU ç‰ˆæœ¬: $LATEST_KSU_VERSION"
          echo "latest_ksu_version=$LATEST_KSU_VERSION" >> $GITHUB_OUTPUT

      - name: "ğŸ“‚ ä»æœ¬åœ°ä»“åº“è·å–å½“å‰ KSU ç‰ˆæœ¬"
        id: fetch-current-ksu-version
        run: |
          # ğŸ§ æ£€æŸ¥ kernel/Makefile æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f kernel/Makefile ]; then
            CURRENT_KSU_VERSION=$(cat kernel/Makefile | grep DKSU_VERSION | cut -d '=' -f2)
            echo "å½“å‰ KSU ç‰ˆæœ¬: $CURRENT_KSU_VERSION"
            echo "current_ksu_version=$CURRENT_KSU_VERSION" >> $GITHUB_OUTPUT
          else
            echo "kernel/Makefile æ–‡ä»¶ä¸å­˜åœ¨ã€‚å°†åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ã€‚"
            echo "current_ksu_version=0" >> $GITHUB_OUTPUT
          fi

      - name: "ğŸ“Š æ¯”è¾ƒ KSU ç‰ˆæœ¬"
        id: compare-versions
        run: |
          CURRENT_KSU_VERSION=${{ steps.fetch-current-ksu-version.outputs.current_ksu_version }}
          LATEST_KSU_VERSION=${{ steps.fetch-latest-ksu-version.outputs.latest_ksu_version }}
          if [ "$CURRENT_KSU_VERSION" != "$LATEST_KSU_VERSION" ]; then
            echo "KSU ç‰ˆæœ¬å·²æ›´æ–°ã€‚è§¦å‘æ„å»ºã€‚"
            echo "trigger_build=true" >> $GITHUB_OUTPUT
          else
            echo "KSU ç‰ˆæœ¬æœªå‘ç”Ÿå˜åŒ–ã€‚æ— éœ€æ„å»ºã€‚"
            echo "trigger_build=false" >> $GITHUB_OUTPUT
          fi

      - name: "ğŸ“ åœ¨æœ¬åœ°ä»“åº“æ›´æ–°æˆ–åˆ›å»º KSU ç‰ˆæœ¬"
        if: ${{ steps.compare-versions.outputs.trigger_build == 'true' }}
        run: |
          # ğŸ“ æ›´æ–°æˆ–åˆ›å»º kernel/Makefile æ–‡ä»¶
          LATEST_KSU_VERSION=${{ steps.fetch-latest-ksu-version.outputs.latest_ksu_version }}
          if [ -f kernel/Makefile ]; then
            # ğŸ“ æ–‡ä»¶å­˜åœ¨ï¼Œæ›´æ–° KSU_VERSION
            rm -f kernel/Makefile
          fi
          # ğŸ“ åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p kernel
          # ğŸ“ åˆ›å»ºæ–°çš„ kernel/Makefile æ–‡ä»¶å¹¶å†™å…¥æœ€æ–°çš„ KSU_VERSION
          echo "DKSU_VERSION=$LATEST_KSU_VERSION" > kernel/Makefile
          echo "å·²åœ¨ kernel/Makefile ä¸­æ›´æ–° KSU ç‰ˆæœ¬ä¸º $LATEST_KSU_VERSION"

      - name: "ğŸš€ æäº¤å¹¶æ¨é€æ›´æ”¹"
        if: ${{ steps.compare-versions.outputs.trigger_build == 'true' }}
        run: |
          # ğŸ“¤ æäº¤æ›´æ”¹
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add kernel/Makefile
          git commit -m "æ›´æ–° KSU_VERSION è‡³ $LATEST_KSU_VERSION"
          git push origin HEAD

      - name: "ğŸ› ï¸ è§¦å‘æ„å»ºå·¥ä½œæµ(OnePlus 11)"
        if: ${{ steps.compare-versions.outputs.trigger_build == 'true' }}
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Build-oneplus_11.yml

      - name: "ğŸ› ï¸ è§¦å‘æ„å»ºå·¥ä½œæµ(OnePlus Ace 3V)"
        if: ${{ steps.compare-versions.outputs.trigger_build == 'true' }}
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Build-oneplus_ace_3v.yml

      - name: "ğŸ› ï¸ è§¦å‘æ„å»ºå·¥ä½œæµ(OnePlus Ace 3Pro)"
        if: ${{ steps.compare-versions.outputs.trigger_build == 'true' }}
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Build-oneplus_ace3_pro.yml

      - name: "ğŸ› ï¸ è§¦å‘æ„å»ºå·¥ä½œæµ(OnePlus 12)"
        if: ${{ steps.compare-versions.outputs.trigger_build == 'true' }}
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Build-oneplus12.yml
